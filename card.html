<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kartu Siswa</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    /* ‚îÄ‚îÄ Design tokens ‚îÄ‚îÄ */
    :root {
      --accent:      #1a6b4a;
      --ink:         #1a1f2e;
      --muted:       #6b7280;
      --bg:          #f5f6f8;
      --surface:     #ffffff;
      --border:      #e5e7eb;
      --font-display:'Playfair Display', Georgia, serif;
      --font-body:   'DM Sans', system-ui, sans-serif;
      --radius:      10px;
      --radius-lg:   18px;
      --shadow-card: 0 4px 24px rgba(0,0,0,0.09), 0 1px 4px rgba(0,0,0,0.05);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-text-size-adjust: 100%; }
    body {
      font-family: var(--font-body); font-size: 15px;
      background: var(--bg); color: var(--ink);
      min-height: 100dvh; -webkit-font-smoothing: antialiased;
    }
    .container { width: 100%; max-width: 480px; margin: 0 auto; padding: 0 1rem; }

    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    #loading {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 80vh; gap: 1rem;
      color: var(--muted); font-size: 0.88rem;
    }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
    #error-view {
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 80vh; gap: 0.75rem;
      padding: 2rem; text-align: center;
    }
    .error-icon { font-size: 3rem; }
    #error-view h2 { color: var(--ink); margin: 0; }
    #error-view p  { color: var(--muted); font-size: 0.88rem; margin: 0; }
    .back-btn {
      margin-top: 1rem; display: inline-block;
      padding: 0.65rem 1.4rem; background: var(--accent); color: #fff;
      border-radius: var(--radius); text-decoration: none;
      font-weight: 600; font-size: 0.88rem;
    }

    /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
    #card-view {
      display: none; padding: 1.25rem 1rem 2rem;
      max-width: 420px; margin: 0 auto;
      animation: fadeUp 0.45s ease both;
    }
    @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

    .top-bar { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.25rem; }
    .top-bar a {
      display: flex; align-items: center; color: var(--muted);
      text-decoration: none; font-size: 0.85rem; gap: 0.3rem; transition: color 0.2s;
    }
    .top-bar a:hover { color: var(--accent); }

    /* identity card */
    .id-card {
      border-radius: var(--radius-lg); overflow: hidden;
      box-shadow: var(--shadow-card); background: var(--surface); margin-bottom: 1.25rem;
    }
    .id-card-header {
      background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent) 70%, #0f2027));
      padding: 1.2rem 1.4rem 3.5rem; position: relative;
    }
    .id-card-header::before, .id-card-header::after {
      content: ''; position: absolute; border-radius: 50%;
      background: rgba(255,255,255,0.07);
    }
    .id-card-header::before { width: 140px; height: 140px; right: -30px; top: -40px; }
    .id-card-header::after  { width: 90px;  height: 90px;  right: 60px;  top: 40px; }
    .school-name {
      font-size: 0.68rem; font-weight: 600; letter-spacing: 0.16em;
      text-transform: uppercase; color: rgba(255,255,255,0.7); margin-bottom: 0.15rem;
    }
    .card-title { font-family: var(--font-display); font-size: 1.2rem; color: #fff; margin: 0; }

    .id-card-body { padding: 0 1.4rem 1.4rem; margin-top: -2.8rem; position: relative; }

    .photo-row { display: flex; align-items: flex-end; gap: 1rem; margin-bottom: 1rem; }
    .student-photo {
      width: 80px; height: 80px; border-radius: var(--radius);
      object-fit: cover; border: 3px solid var(--surface);
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      background: var(--border); flex-shrink: 0;
    }
    .student-meta { padding-top: 2rem; flex: 1; min-width: 0; }
    .student-class {
      display: inline-block; font-size: 0.8rem; font-weight: 600;
      letter-spacing: 0.12em; text-transform: uppercase;
      color: #fff;
      background: var(--accent);
      border-radius: 100px; padding: 0.2rem 0.7rem; margin-bottom: 0.3rem;
    }
    .student-name {
      font-family: var(--font-display); font-size: 1.25rem; line-height: 1.2;
      color: var(--ink); margin: 0 0 0.1rem;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .nomor-induk { font-size: 0.78rem; color: var(--muted); font-feature-settings: "tnum"; }

    /* section title */
    .section-title {
      font-size: 0.7rem; font-weight: 600; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem;
    }

    /* kompetensi */
    .competency-list { display: flex; flex-direction: column; gap: 0.6rem; margin-bottom: 1.25rem; }
    .comp-item { display: flex; align-items: center; gap: 0.75rem; }
    .comp-label { font-size: 0.82rem; color: var(--ink); width: 130px; flex-shrink: 0; }
    .comp-bar-wrap {
      flex: 1; height: 6px; background: var(--border);
      border-radius: 100px; overflow: hidden;
    }
    .comp-bar {
      height: 100%; border-radius: 100px;
      background: linear-gradient(90deg, var(--accent), color-mix(in srgb, var(--accent) 60%, #4ade80));
      transition: width 0.8s cubic-bezier(.22,1,.36,1);
    }
    .comp-val {
      font-size: 0.78rem; font-weight: 600; color: var(--accent);
      width: 28px; text-align: right; font-feature-settings: "tnum";
    }

    /* catatan */
    .notes-box { background: var(--bg); border-radius: var(--radius); padding: 0.9rem 1rem; margin-bottom: 1.25rem; }
    .notes-text { font-size: 0.85rem; color: var(--ink); line-height: 1.6; white-space: pre-wrap; }
    .notes-text.empty { color: var(--muted); font-style: italic; }

    /* footer */
    .card-footer {
      border-top: 1px solid var(--border); padding-top: 0.9rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    .id-chip { font-size: 0.72rem; font-feature-settings: "tnum"; color: var(--muted); }
    .print-btn {
      font-size: 0.78rem; font-weight: 600; color: var(--accent);
      cursor: pointer; background: none; border: none; padding: 0; font-family: var(--font-body);
    }
    .print-btn:hover { text-decoration: underline; }

    @media print {
      body { background: #fff; }
      .top-bar, .print-btn { display: none !important; }
      #card-view { display: block !important; }
      .id-card { box-shadow: none; border: 1px solid #ccc; }
    }
  </style>
</head>
<body>
  <main class="container">

    <div id="loading">
      <div class="spinner"></div>
      <span>Mengambil data siswa‚Ä¶</span>
    </div>

    <div id="error-view">
      <div class="error-icon">üîç</div>
      <h2 id="error-title">Data Tidak Ditemukan</h2>
      <p id="error-msg">Pastikan student_id benar atau hubungi administrator.</p>
      <a class="back-btn" href="index.html">‚Üê Kembali ke Scanner</a>
    </div>

    <div id="card-view">
      <div class="top-bar">
        <a href="index.html">‚Üê Scanner</a>
      </div>

      <div class="id-card">
        <div class="id-card-header">
          <div class="school-name">Kartu Identitas Siswa</div>
          <p class="card-title">Data Profil Siswa</p>
        </div>
        <div class="id-card-body">
          <div class="photo-row">
            <img class="student-photo" id="photo"
                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23e5e7eb' rx='10'/%3E%3Ccircle cx='40' cy='30' r='14' fill='%239ca3af'/%3E%3Cellipse cx='40' cy='70' rx='22' ry='18' fill='%239ca3af'/%3E%3C/svg%3E"
                 alt="Foto Siswa" />
            <div class="student-meta">
              <span class="student-class" id="kelas">‚Äî</span>
              <h2 class="student-name" id="nama">‚Äî</h2>
              <div class="nomor-induk">NIS: <span id="nomor-induk">‚Äî</span></div>
            </div>
          </div>

          <div class="section-title">Kompetensi</div>
          <div class="competency-list" id="competency-list"></div>

          <div class="section-title">Catatan</div>
          <div class="notes-box">
            <div class="notes-text" id="catatan">‚Äî</div>
          </div>

          <div class="card-footer">
            <span class="id-chip">ID: <span id="student-id-chip">‚Äî</span></span>
            <button class="print-btn" onclick="window.print()">üñ® Cetak</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // ‚îÄ‚îÄ Ganti dengan URL deploy Apps Script kamu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbza_7KWD66iJZGIh6xBuzRaphKHDyMaZZ3Evo_F6fTgF8N13rjRyCGfKCuFFi4lUhW5cA/exec';
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const KOMPETENSIS = [
      { key: 'kompetensi_kedisiplinan',  label: 'Kedisiplinan'  },
      { key: 'kompetensi_kepemimpinan',  label: 'Kepemimpinan'  },
      { key: 'kompetensi_kerajinan',     label: 'Kerajinan'     },
      { key: 'kompetensi_publikasi',     label: 'Publikasi'      },
    ];

    const DEFAULT_PHOTO = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23e5e7eb' rx='10'/%3E%3Ccircle cx='40' cy='30' r='14' fill='%239ca3af'/%3E%3Cellipse cx='40' cy='70' rx='22' ry='18' fill='%239ca3af'/%3E%3C/svg%3E";

    function el(id) { return document.getElementById(id); }

    function showError(title, msg) {
      el('loading').style.display    = 'none';
      el('card-view').style.display  = 'none';
      el('error-view').style.display = 'flex';
      el('error-title').textContent  = title || 'Terjadi Kesalahan';
      el('error-msg').textContent    = msg   || '';
    }

    function showCard() {
      el('loading').style.display    = 'none';
      el('error-view').style.display = 'none';
      el('card-view').style.display  = 'block';
    }

    function renderKompetensi(data) {
      const list = el('competency-list');
      list.innerHTML = '';
      KOMPETENSIS.forEach(({ key, label }) => {
        const raw = data[key];
        const val = raw !== undefined && raw !== '' ? Number(raw) : null;
        const pct = val !== null ? Math.min(100, Math.max(0, val)) : 0;
        const item = document.createElement('div');
        item.className = 'comp-item';
        item.innerHTML = `
          <span class="comp-label">${label}</span>
          <div class="comp-bar-wrap">
            <div class="comp-bar" style="width:0%" data-pct="${pct}"></div>
          </div>
          <span class="comp-val">${val !== null ? val : '‚Äî'}</span>
        `;
        list.appendChild(item);
      });
      // Animasi bar setelah render
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          list.querySelectorAll('.comp-bar').forEach(bar => {
            bar.style.width = bar.dataset.pct + '%';
          });
        });
      });
    }

    async function loadCard() {
      const id = new URLSearchParams(location.search).get('id');

      if (!id) {
        showError('ID Tidak Ditemukan', 'URL tidak mengandung parameter id. Kembali ke scanner dan coba lagi.');
        return;
      }

      try {
        const url = `${ENDPOINT}?id=${encodeURIComponent(id)}`;

        // PENTING: jangan tambahkan mode:'cors'
        // Apps Script redirect ke URL eksekusi baru; mode:'cors' menyebabkan
        // preflight CORS pada redirect gagal dan fetch throw error diam-diam.
        const res = await fetch(url, { redirect: 'follow' });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const json = await res.json();

        if (!json.success) {
          showError('Data Tidak Ditemukan', `Siswa dengan ID "${id}" tidak terdaftar dalam sistem.`);
          return;
        }

        const d = json.data;

        // Foto
        const photo = el('photo');
        if (d.foto_url && d.foto_url.trim()) {
          photo.src = d.foto_url.trim();
          photo.onerror = () => { photo.src = DEFAULT_PHOTO; };
        }

        el('nama').textContent            = d.nama        || '‚Äî';
        el('kelas').textContent           = d.kelas        || '‚Äî';
        el('nomor-induk').textContent     = d.nomor_induk  || '‚Äî';
        el('student-id-chip').textContent = d.student_id   || id;

        // Catatan
        const catatanEl = el('catatan');
        if (d.catatan && String(d.catatan).trim()) {
          catatanEl.textContent = String(d.catatan).trim();
          catatanEl.classList.remove('empty');
        } else {
          catatanEl.textContent = 'Tidak ada catatan.';
          catatanEl.classList.add('empty');
        }

        renderKompetensi(d);
        document.title = `Kartu Siswa ‚Äî ${d.nama || id}`;
        showCard();

      } catch (err) {
        console.error(err);
        showError(
          'Gagal Mengambil Data',
          'Pastikan koneksi internet aktif dan Apps Script sudah di-deploy ulang dengan akses "Anyone". Detail: ' + err.message
        );
      }
    }

    window.addEventListener('DOMContentLoaded', loadCard);
  </script>
</body>
</html>
